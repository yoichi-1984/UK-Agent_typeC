"""
UK-Agent-TypeC Verifier: è¨ˆç”»æ¤œè¨¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€‚

å®Ÿè¡Œã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½“åˆã®ç›®çš„ã‚’é”æˆã—ã¦ã„ã‚‹ã‹ã‚’ã€
æç¤ºã•ã‚ŒãŸè¨¼æ‹ ã®ã¿ã‚’å…ƒã«åˆ¤æ–­ã—ã€æœ€çµ‚çš„ãªæˆåŠŸãƒ»å¤±æ•—ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
"""
import os


from langchain_core.messages import SystemMessage

from .schema import VerificationResult
from ..llm_client import get_llm_client

# --- Verifierã®ãƒ­ã‚¸ãƒƒã‚¯ (ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ·æ–°) ---
def verify_task(
    objective: str, original_plan: str, execution_summary: str
) -> VerificationResult:
    """
    å®Ÿè¡Œã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½“åˆã®ç›®çš„ã‚’é”æˆã—ã¦ã„ã‚‹ã‹ã‚’ã€
    æç¤ºã•ã‚ŒãŸæƒ…å ±ã®ã¿ã«åŸºã¥ã„ã¦åˆ¤æ–­ã™ã‚‹ã€‚
    """
    print("\nğŸ” VerifierãŒä½œæ¥­çµæœã®æ¤œè¨¼ã‚’é–‹å§‹...")

    # --- æœ€çµ‚åˆ¤æ–­ ---
    final_judgment_prompt = f"""ã‚ãªãŸã¯ã€æç¤ºã•ã‚ŒãŸè¨¼æ‹ ã®ã¿ã‚’å…ƒã«æœ€çµ‚çš„ãªåˆ¤æ–­ã‚’ä¸‹ã™ã€
æ¥µã‚ã¦å³æ ¼ã§æ³¨æ„æ·±ã„å“è³ªä¿è¨¼ï¼ˆQAï¼‰ã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆï¼ˆè£åˆ¤å®˜ï¼‰ã§ã™ã€‚æ€è€ƒã¨è¨€èªã¯æ—¥æœ¬èªã§è¡Œã£ã¦ãã ã•ã„ã€‚
ã‚ãªãŸã¯ã€ã“ã‚Œä»¥ä¸Šãƒ„ãƒ¼ãƒ«ã‚’å‘¼ã³å‡ºã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚

**å¯©è­°å¯¾è±¡:**
---
1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½“åˆã®ç›®çš„:**
{objective}

2. **å®Ÿè¡Œã•ã‚ŒãŸè¨ˆç”»ã®æ€è€ƒ:**
{original_plan}

3. **å®Ÿè¡Œçµæœã®æœ€çµ‚è¦ç´„ï¼ˆäº‹å®Ÿï¼‰:**
{execution_summary}
---

**åˆ¤æ–­åŸºæº–:**
- **ãƒ¬ãƒãƒ¼ãƒˆã‚¿ã‚¹ã‚¯ã®ç‰¹åˆ¥ãƒ«ãƒ¼ãƒ«**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®çš„ãŒã€Œãƒ¬ãƒãƒ¼ãƒˆä½œæˆã€ã€Œèª¿æŸ»ã€ã€Œåˆ†æã€ãªã©ã§ã‚ã‚Šã€è¨ˆç”»ã®æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ãŒ`read_file`ã§ã‚ã£ãŸå ´åˆã€ã€Œå®Ÿè¡Œçµæœã®æœ€çµ‚è¦ç´„ã€ã«å«ã¾ã‚Œã‚‹`read_file`ã®çµæœï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ï¼‰ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ã«å¯¾ã™ã‚‹**å®Œå…¨ãªç­”ãˆãã®ã‚‚ã®**ã§ã™ã€‚ãã®å†…å®¹ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®çš„ã«å¯¾ã—ã¦ååˆ†ãªè©³ç´°ã•ã§æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‹ã‚’è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚å†…å®¹ãŒå……å®Ÿã—ã¦ã„ã‚Œã°ã€ã‚¿ã‚¹ã‚¯ã¯ã€ŒæˆåŠŸã€ã§ã™ã€‚è¿½åŠ ã®è¦ç´„ã‚’è¦æ±‚ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚
- **ã‚¨ãƒ©ãƒ¼ã®å³æ ¼ãªæ‰±ã„**: ã€Œå®Ÿè¡Œçµæœã®æœ€çµ‚è¦ç´„ã€ã« 'Error:' ã¨ã„ã†æ–‡å­—åˆ—ãŒ**ä¸€ã¤ã§ã‚‚å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ**ã€åŸå‰‡ã¨ã—ã¦ã‚¿ã‚¹ã‚¯ã¯**ã€Œå¤±æ•—ã€**ã§ã™ã€‚
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼ã®ç‰¹åˆ¥è§£é‡ˆ**: ã‚‚ã— 'Error:' ã®å†…å®¹ãŒ 'Access denied' ã ã£ãŸå ´åˆã€ã“ã‚Œã¯æ„å›³ã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã§ã™ã€‚ã‚¿ã‚¹ã‚¯ã¯ã€Œå¤±æ•—ã€ã¨åˆ¤æ–­ã—ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã§ã¯**å¿…ãš**ã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã«ã‚ˆã‚Šã€ã“ã®æ“ä½œã¯è¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã€ã¨ã ã‘å ±å‘Šã—ã¦ãã ã•ã„ã€‚
- **æˆåŠŸã®å®šç¾©**: ä¸Šè¨˜ã®ãƒ«ãƒ¼ãƒ«ã«å½“ã¦ã¯ã¾ã‚‰ãªã„å ´åˆã€ã€Œå®Ÿè¡Œçµæœã®æœ€çµ‚è¦ç´„ã€ã«**ä¸€åˆ‡ã®ã‚¨ãƒ©ãƒ¼ãŒãªã**ã€ã‹ã¤ãã®å†…å®¹ãŒã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å½“åˆã®ç›®çš„ã€ã‚’å®Œå…¨ã«æº€ãŸã—ã¦ã„ã‚‹å ´åˆã®ã¿ã€ã‚¿ã‚¹ã‚¯ã¯æˆåŠŸã§ã™ã€‚

ä»¥ä¸Šã®ã™ã¹ã¦ã®æƒ…å ±ã«åŸºã¥ãã€ã‚¿ã‚¹ã‚¯ãŒå®Œå…¨ã«æˆåŠŸã—ãŸã‹ã€ãã‚Œã¨ã‚‚ä¸å®Œå…¨ã¾ãŸã¯å¤±æ•—ã—ãŸã‹ã‚’åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚
æœ€çµ‚çš„ãªåˆ¤æ–­ã‚’ã€æŒ‡å®šã•ã‚ŒãŸJSONå½¢å¼(`VerificationResult`)ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

**ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«é–¢ã™ã‚‹é‡è¦ãƒ«ãƒ¼ãƒ«:**
- **æˆåŠŸã—ãŸå ´åˆ:** `feedback`ã«ã¯ã€å¾Œã®ãƒ—ãƒ­ã‚»ã‚¹ã§åˆ©ç”¨ã™ã‚‹ãŸã‚ã€ç°¡æ½”ã«ã€Œã‚¿ã‚¹ã‚¯ã¯æ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚ã€ã¨ã ã‘è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®è©³ç´°ãªå ±å‘Šã¯ã€ã“ã®å¾Œå°‚é–€ã®ReporterãŒè¡Œã„ã¾ã™ã€‚
- **å¤±æ•—ã—ãŸå ´åˆ:** `feedback`ã«ã¯ã€å˜ãªã‚‹ã‚¨ãƒ©ãƒ¼å†…å®¹ã®å ±å‘Šã«ç•™ã‚ãšã€ã€Œã€‡ã€‡ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ã“ã‚Œã¯â–³â–³ãŒåŸå› ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚æ¬¡ã®è©¦è¡Œã§ã¯ã€â–¡â–¡ã¨ã„ã†ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§è§£æ±ºã‚’è©¦ã¿ã¾ã™ã€‚ã€ã®ã‚ˆã†ã«ã€**åŸå› ã®æ¨æ¸¬ã¨ã€å…·ä½“çš„ãªæ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**ã‚’å¿…ãšã‚»ãƒƒãƒˆã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
- **ã€é‡è¦ã€‘å¼•æ•°ã‚¨ãƒ©ãƒ¼ã®æ‰±ã„:** ã‚‚ã—ã‚¨ãƒ©ãƒ¼ãŒ `unexpected keyword argument` ã«é–¢ã™ã‚‹ã‚‚ã®ã§ã‚ã£ãŸå ´åˆã€**å¼•æ•°åã‚’å®‰æ˜“ã«æ¨æ¸¬ã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚** Supervisorã«å¯¾ã—ã¦ã€Œ**ãƒ„ãƒ¼ãƒ«ã®å®šç¾©ã‚’å†ç¢ºèªã—ã€æ­£ã—ã„å¼•æ•°åã§å†å®Ÿè¡Œã™ã‚‹**ã€ã‚ˆã†ã«æ˜ç¢ºã«æŒ‡ç¤ºã—ã¦ãã ã•ã„ã€‚å®‰æ˜“ãªä»£æ›¿æ¡ˆï¼ˆä¾‹: 'path' ã‚’ 'file_path' ã«ã™ã‚‹ãªã©ï¼‰ã‚’æç¤ºã™ã‚‹ã“ã¨ã¯ç¦æ­¢ã—ã¾ã™ã€‚ # â—€ï¸ ã“ã®ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ 
"""

    judgment_llm = get_llm_client().with_structured_output(
        VerificationResult, method="function_calling"
    )

    try:
        print("  -> æœ€çµ‚åˆ¤æ–­ã‚’ä¸‹ã—ã¦ã„ã¾ã™...")
        result = judgment_llm.invoke(
            [SystemMessage(content=final_judgment_prompt)]
        )
        if result.is_success:
            print("  -> Verifierã®æœ€çµ‚åˆ¤æ–­: æˆåŠŸ âœ¨")
        else:
            print(f"  -> Verifierã®æœ€çµ‚åˆ¤æ–­: å¤±æ•—/ä¸å®Œå…¨ âŒ\n  -> ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯: {result.feedback}")
        return result
    except Exception as e:  # pylint: disable=broad-exception-caught
        print(f"\nâš ï¸ æ¤œè¨¼ã®æœ€çµ‚åˆ¤æ–­ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return VerificationResult(
            is_success=False,
            feedback="æ¤œè¨¼ã®æœ€çµ‚åˆ¤æ–­ãƒ—ãƒ­ã‚»ã‚¹ã§äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
        )
